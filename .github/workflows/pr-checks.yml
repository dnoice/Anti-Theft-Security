# File: .github/workflows/pr-checks.yml

name: ðŸ” Pull Request Checks

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: pr-checks-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # ================================================
  # QUICK VALIDATION CHECKS
  # ================================================
  validation:
    name: âš¡ Quick Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event.pull_request.draft == false
    
    steps:
    - name: ðŸ“¥ Checkout PR
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ”§ Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ðŸ“± Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: ðŸŽ¯ Grant execute permission
      run: chmod +x gradlew
      
    - name: ðŸ” Validate Gradle wrapper
      uses: gradle/wrapper-validation-action@v2
      
    - name: ðŸ“¦ Cache Gradle
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-pr-${{ hashFiles('**/*.gradle*') }}
        restore-keys: |
          ${{ runner.os }}-gradle-pr-
          ${{ runner.os }}-gradle-
          
    - name: âœ… Check code compiles
      run: ./gradlew compileDebugSources --parallel
      
    - name: ðŸ§ª Run unit tests
      run: ./gradlew testDebugUnitTest --parallel
      
    - name: ðŸ“Š Publish test results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: ðŸ§ª Unit Test Results
        path: app/build/test-results/testDebugUnitTest/TEST-*.xml
        reporter: java-junit

  # ================================================
  # CODE QUALITY ANALYSIS
  # ================================================
  code-quality:
    name: ðŸ“Š Code Quality Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event.pull_request.draft == false
    
    steps:
    - name: ðŸ“¥ Checkout PR
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ”§ Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ðŸ“± Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: ðŸŽ¯ Grant execute permission
      run: chmod +x gradlew
      
    - name: ðŸ“¦ Cache Gradle
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-quality-${{ hashFiles('**/*.gradle*') }}
        restore-keys: |
          ${{ runner.os }}-gradle-quality-
          ${{ runner.os }}-gradle-
          
    - name: ðŸ” Run lint checks
      run: ./gradlew lintDebug --parallel
      
    - name: ðŸ“Š Upload lint results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: lint-results-pr-${{ github.event.pull_request.number }}
        path: app/build/reports/lint-results*.html
        retention-days: 14
        
    - name: ðŸ“ Comment lint results
      uses: yutailang0119/action-android-lint@v3
      if: always()
      with:
        report-path: app/build/reports/lint-results-debug.xml
      continue-on-error: true

  # ================================================
  # SECURITY SCAN
  # ================================================
  security-scan:
    name: ðŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event.pull_request.draft == false
    
    steps:
    - name: ðŸ“¥ Checkout PR
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ›¡ï¸ Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: java
        
    - name: ðŸ”§ Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ðŸ“± Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: ðŸŽ¯ Grant execute permission
      run: chmod +x gradlew
      
    - name: ðŸ—ï¸ Build for security analysis
      run: ./gradlew compileDebugSources
      
    - name: ðŸ›¡ï¸ Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

  # ================================================
  # BUILD TEST APK
  # ================================================
  build-test:
    name: ðŸ—ï¸ Build Test APK
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event.pull_request.draft == false
    
    steps:
    - name: ðŸ“¥ Checkout PR
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ðŸ“± Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: ðŸŽ¯ Grant execute permission
      run: chmod +x gradlew
      
    - name: ðŸ“¦ Cache Gradle
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-build-${{ hashFiles('**/*.gradle*') }}
        restore-keys: |
          ${{ runner.os }}-gradle-build-
          ${{ runner.os }}-gradle-
          
    - name: ðŸ—ï¸ Build debug APK
      run: ./gradlew assembleDebug --parallel
      
    - name: ðŸ” Verify APK exists
      run: |
        APK_PATH=$(find app/build/outputs/apk/debug -name "*.apk" | head -1)
        if [ -f "$APK_PATH" ]; then
          echo "âœ… APK built successfully: $APK_PATH"
          APK_SIZE=$(stat -c%s "$APK_PATH")
          APK_SIZE_MB=$(echo "scale=2; $APK_SIZE / 1024 / 1024" | bc)
          echo "ðŸ“¦ APK Size: ${APK_SIZE_MB} MB"
          
          # Add to PR comment
          echo "### ðŸ“± PR Build Results" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… APK built successfully" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Size: ${APK_SIZE_MB} MB" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ·ï¸ File: $(basename $APK_PATH)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ APK build failed"
          exit 1
        fi
        
    - name: ðŸ“¤ Upload PR APK
      uses: actions/upload-artifact@v4
      with:
        name: pr-${{ github.event.pull_request.number }}-debug-apk
        path: app/build/outputs/apk/debug/*.apk
        retention-days: 7

  # ================================================
  # PR SUMMARY COMMENT
  # ================================================
  pr-summary:
    name: ðŸ“ PR Summary
    runs-on: ubuntu-latest
    needs: [validation, code-quality, security-scan, build-test]
    if: always() && github.event.pull_request.draft == false
    
    steps:
    - name: ðŸ“ Create PR comment
      uses: actions/github-script@v7
      with:
        script: |
          const jobs = {
            validation: '${{ needs.validation.result }}',
            'code-quality': '${{ needs.code-quality.result }}',
            'security-scan': '${{ needs.security-scan.result }}',
            'build-test': '${{ needs.build-test.result }}'
          };
          
          const getEmoji = (result) => {
            switch(result) {
              case 'success': return 'âœ…';
              case 'failure': return 'âŒ';
              case 'cancelled': return 'â¹ï¸';
              case 'skipped': return 'â­ï¸';
              default: return 'ðŸ”„';
            }
          };
          
          const getStatus = (result) => {
            switch(result) {
              case 'success': return 'Passed';
              case 'failure': return 'Failed';
              case 'cancelled': return 'Cancelled';
              case 'skipped': return 'Skipped';
              default: return 'Running';
            }
          };
          
          let comment = `## ðŸ¤– PR Checks Summary\n\n`;
          comment += `| Check | Status | Result |\n`;
          comment += `|-------|--------|--------|\n`;
          
          for (const [job, result] of Object.entries(jobs)) {
            const emoji = getEmoji(result);
            const status = getStatus(result);
            comment += `| ${job.replace('-', ' ')} | ${emoji} | ${status} |\n`;
          }
          
          comment += `\n### ðŸ“± Test APK\n`;
          if (jobs['build-test'] === 'success') {
            comment += `âœ… **Debug APK built successfully!**\n`;
            comment += `ðŸ“¥ Download from the "Artifacts" section in the [Actions tab](${context.payload.pull_request.html_url.replace('/pull/', '/actions')}).\n\n`;
            comment += `ðŸ”— Artifact name: \`pr-${context.payload.pull_request.number}-debug-apk\`\n`;
          } else {
            comment += `âŒ APK build failed. Check the logs for details.\n`;
          }
          
          comment += `\n---\n`;
          comment += `ðŸ”„ **Workflow run**: [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})\n`;
          comment += `ðŸ“ **Commit**: ${context.sha.substring(0, 7)}\n`;
          
          // Post or update comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.payload.pull_request.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('ðŸ¤– PR Checks Summary')
          );
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: comment
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });
          }
